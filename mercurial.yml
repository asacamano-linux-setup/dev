- name: Install mercurial
  become_user: "{{ target_user }}"
  shell: "{{ target_home }}/miniconda2/condabin/conda install --yes mercurial && touch {{ target_home }}/.sync/dev/mercurial-installed"
  args:
    creates: "{{ target_home }}/.sync/dev/mercurial-installed"

- name: Install mercurial-git
  become_user: "{{ target_user }}"
  shell: "{{ target_home }}/miniconda2/condabin/conda install --yes -c conda-forge hg-git && touch {{ target_home }}/.sync/dev/hg-git-installed"
  args:
    creates: "{{ target_home }}/.sync/dev/hg-git-installed"

- name: Install dulwich
  become_user: "{{ target_user }}"
  shell: "{{ target_home }}/miniconda2/condabin/conda install --yes dulwich && touch {{ target_home }}/.sync/dev/dulwich-installed"
  args:
    creates: "{{ target_home }}/.sync/dev/dulwich-installed"

- name: where is hg-git
  shell: "{{ target_home }}/miniconda2/condabin/conda list | grep hg-git | awk '{print $1\"-\"$2\"-\"$3}'"
  register: hggitwhere

- set_fact: 
    hggitpath={{ hggitwhere.stdout }}

- name: .hgrc git 
  ini_file:
    create: true
    path: "{{ target_home }}/.hgrc"
    owner:  "{{ target_user }}"
    group:  "{{ target_group }}"
    mode: 0440
    backup: true
    section: extensions
    option: hggit
    value: "{{ target_home }}/miniconda2/pkgs/{{ hggitpath }}/site-packages/hggit"
 
- name: .hgrc bookmarks
  ini_file:
    path: "{{ target_home }}/.hgrc"
    backup: true
    section: extensions
    option: hgext.bookmarks
    value: ""
 
- name: .hgrc verbose
  ini_file:
    path: "{{ target_home }}/.hgrc"
    backup: true
    section: ui
    option: verbose
    value: "true"
 
- name: .hgrc username
  ini_file:
    path: "{{ target_home }}/.hgrc"
    backup: true
    section: ui
    option: username
    value: "{{ target_git_name }} <{{ target_git_email }}>"
